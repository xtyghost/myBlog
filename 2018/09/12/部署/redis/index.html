<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>redis | Study Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="链接redis 时只能通过本地localhost (127.0.0.1）这个来链接，而不能用网络ip(192.168..)这个链接，问题然如果用网络ip 链接会报以下的错误： 1(error) DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specif">
<meta name="keywords" content="deploy">
<meta property="og:type" content="article">
<meta property="og:title" content="redis">
<meta property="og:url" content="fkghost.com/2018/09/12/部署/redis/index.html">
<meta property="og:site_name" content="Study Blog">
<meta property="og:description" content="链接redis 时只能通过本地localhost (127.0.0.1）这个来链接，而不能用网络ip(192.168..)这个链接，问题然如果用网络ip 链接会报以下的错误： 1(error) DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specif">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-12-30T16:46:37.275Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis">
<meta name="twitter:description" content="链接redis 时只能通过本地localhost (127.0.0.1）这个来链接，而不能用网络ip(192.168..)这个链接，问题然如果用网络ip 链接会报以下的错误： 1(error) DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specif">
  
    <link rel="alternate" href="/atom.xml" title="Study Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Study Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">不仅有工作，更有生活</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="fkghost.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-部署/redis" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/12/部署/redis/" class="article-date">
  <time datetime="2018-09-12T12:59:23.465Z" itemprop="datePublished">2018-09-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      redis
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>链接redis 时只能通过本地localhost (127.0.0.1）这个来链接，而不能用网络ip(192.168..)这个链接，问题然如果用网络ip 链接会报以下的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(error) DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the lookback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just disable protected mode sending the command &apos;CONFIG SET protected-mode no&apos; from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. 2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to &apos;no&apos;, and then restarting the server. 3) If you started the server manually just for testing, restart it with the --portected-mode no option. 4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.1</span><br></pre></td></tr></table></figure>
<p>是说处于保护模式，只能本地链接，我们需要修改配置文件../redis.conf<br>1)打开配置文件把下面对应的注释掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># bind 127.0.0.1 1</span><br></pre></td></tr></table></figure>
<p>2)Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程，设置为no</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize no1</span><br></pre></td></tr></table></figure>
<p>3)保护模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected-mode no</span><br></pre></td></tr></table></figure>
<p>4)带上配置文件启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-server ../redis.conf</span><br></pre></td></tr></table></figure>
<p>requirepass是用来设置密码的</p>
<h2 id="redis集群搭建"><a href="#redis集群搭建" class="headerlink" title="redis集群搭建"></a>redis集群搭建</h2><ul>
<li>安装ruby环境</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ruby</span><br><span class="line">yum install rubygems</span><br></pre></td></tr></table></figure>
<ul>
<li>安装ruby和redis的接口程序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　gem install redis</span><br></pre></td></tr></table></figure>
<ul>
<li>redis requires Ruby version &gt;= 2.2.2的报错</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">解决办法是 先安装rvm，再把ruby版本提升至2.3.3</span><br><span class="line">1.安装curl</span><br><span class="line"></span><br><span class="line">sudo yum install curl</span><br><span class="line"></span><br><span class="line">2. 安装RVM</span><br><span class="line"></span><br><span class="line">$  gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</span><br><span class="line"></span><br><span class="line">$   \curl -sSL https://get.rvm.io | bash -s stable </span><br><span class="line"></span><br><span class="line">3. source /usr/local/rvm/scripts/rvm</span><br><span class="line"></span><br><span class="line">4. 查看rvm库中已知的ruby版本</span><br><span class="line"></span><br><span class="line">rvm list known</span><br><span class="line"></span><br><span class="line">5. 安装一个ruby版本</span><br><span class="line"></span><br><span class="line">rvm install 2.3.3</span><br><span class="line"></span><br><span class="line">6. 使用一个ruby版本</span><br><span class="line"></span><br><span class="line">rvm use 2.3.3</span><br><span class="line"></span><br><span class="line">7. 设置默认版本</span><br><span class="line"></span><br><span class="line">rvm remove 2.0.0</span><br><span class="line"></span><br><span class="line">8. 卸载一个已知版本</span><br><span class="line"></span><br><span class="line">ruby --version</span><br><span class="line"></span><br><span class="line">9. 再安装redis就可以了</span><br><span class="line"></span><br><span class="line">gem install redis</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> 参考博客：</span><br><span class="line"></span><br><span class="line">http://blog.csdn.net/lixwjava/article/details/50408070 </span><br><span class="line"></span><br><span class="line">http://blog.csdn.net/fengye_yulu/article/details/77628094</span><br></pre></td></tr></table></figure>
<h3 id="集群结点规划"><a href="#集群结点规划" class="headerlink" title="集群结点规划　　"></a><strong>集群结点规划</strong>　　</h3><p>　　　　<strong>这里在同一台服务器用不同的端口表示不同的redis服务器，如下：</strong><br>　　　　<strong>主节点：10.211.55.8:7001 10.211.55.8:7002 10.211.55.8:7003</strong><br>　　　　<strong>从节点：10.211.55.8:7004 10.211.55.8:7005 10.211.55.8:7006</strong></p>
<p>​           <strong>在/usr/local下创建redis-cluster目录，其下创建7001、7002。。7006目录，如下：</strong></p>
<p>　<strong>将redis安装目录bin下的文件拷贝到每个700X目录内，同时将redis源码目录src下的redis-trib.rb拷贝到redis-cluster目录下。</strong></p>
<p>　　　　<strong>修改每个700X目录下的redis.conf配置文件：</strong></p>
<p>　　　　<strong>port XXXX</strong></p>
<p>　　　　<strong>cluster-enabled yes</strong></p>
<p>​         将bind 10.211.55.5:700x</p>
<p>​       requirepass注释 </p>
<p>　　<strong>启动每个节点redis服务</strong>　　　</p>
<p>　　<strong>分别进入7001、7002、…7006目录，执行：</strong></p>
<p>　　<strong>./redis-server ./redis.conf</strong></p>
<h3 id="执行创建集群命令"><a href="#执行创建集群命令" class="headerlink" title="执行创建集群命令"></a><strong>执行创建集群命令</strong></h3><p>　　　　<strong>在/usr/local/redis-cluster/</strong></p>
<p>　　　　<strong>执行redis-trib.rb，此脚本是ruby脚本，它依赖ruby环境。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">　./redis-trib.rb create --replicas 1 10.211.55.8:7001 10.211.55.8:7002 10.211.55.8:7003 10.211.55.8:7004 10.211.55.8:7005  10.211.55.8:7006</span><br></pre></td></tr></table></figure>
<p>错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Node 10.211.55.8:7001 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.</span><br><span class="line">数据库不干净</span><br><span class="line">./redis-cli -h 10.211.55.8 -p 7001</span><br><span class="line">flushdb清空数据库</span><br><span class="line">cluster reset</span><br><span class="line">cluster info查看集群状态</span><br></pre></td></tr></table></figure>
<p>查看信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ruby redis-trib.rb info 10.180.157.199:6379</span><br></pre></td></tr></table></figure>
<p>检查集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">检查集群状态的命令，没有其他参数，只需要选择一个集群中的一个节点即可。执行命令以及结果如下：</span><br><span class="line"></span><br><span class="line">$ ruby redis-trib.rb check 10.180.157.199:6379</span><br></pre></td></tr></table></figure>
<p>设置心跳时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby redis-trib.rb set-timeout 10.180.157.199:6379 30000</span><br></pre></td></tr></table></figure>
<p>添加新节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">添加节点命令可以将新节点加入集群，节点可以为大师，也可以为某个主节点的奴隶。</span><br><span class="line"></span><br><span class="line">添加节点new_host：new_port existing_host：existing_port </span><br><span class="line">          --slave </span><br><span class="line">          --master-ID &lt;ARG&gt; </span><br><span class="line">添加节点有两个可选参数：--slave </span><br><span class="line"></span><br><span class="line">：设置该参数，则新节点以slave的角色加入集群</span><br><span class="line">--master-id：这个参数需要设置了--slave才能生效， - master-id用来指定新节点的主节点。如果不设置该参数，则会随机为节点选择主节点。</span><br><span class="line">可以看下add-node命令的执行示例：</span><br><span class="line"></span><br><span class="line">$ ruby redis-trib.rb add-node --slave --master-id dcb792b3e85726f012e83061bf237072dfc45f99 10.180 .157.202：6379 10.180.157.199:6379</span><br></pre></td></tr></table></figure>
<p>导入外部redis数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./redis-trib.rb import --from 10.0.10.1:6379 10.10.10.1:7000上面</span><br><span class="line">的命令是把10.0.10.1:6379(redis 2.8）上的数据导入到10.10.10.1:7000这个节点所在的集群</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">可以看到redis-trib.rb具有以下功能：</span><br><span class="line">1，创建：创建集群</span><br><span class="line">2，检查：检查集群</span><br><span class="line">3，信息：查看集群信息</span><br><span class="line">4，修复：修复集群</span><br><span class="line">5，reshard：在线迁移时隙</span><br><span class="line">6，重新平衡集群节点时隙数量</span><br><span class="line">7，add-node：将新节点加入集群</span><br><span class="line">8，del node：从集群中删除节点</span><br><span class="line">9，set-timeout：设置集群节点间心跳连接的超时时间</span><br><span class="line">10，call：在集群全部节点上执行命令</span><br><span class="line">11，import：将外部redis数据导入集群</span><br></pre></td></tr></table></figure>
<p>ruby 是一种语言，是某些软件包代码的执行环境。而<code>gem</code>是管理这些基于ruby程序的程序。</p>
<ol>
<li>执行 <code>gem environment</code> </li>
</ol>
<blockquote>
<ul>
<li>GEM PATHS:</li>
</ul>
<ul>
<li>/usr/local/lib/ruby/gems/2.3.0 </li>
<li>/Users/Encoder/.gem/ruby/2.3.0 </li>
<li>/usr/local/Cellar/ruby/2.3.0/lib/ruby/gems/2.3.0</li>
<li>根据 <code>GEM PATHS:</code> 列出的路径查找目录。</li>
<li>所安装的程序包就在所指目录下面的 <code>gems</code> 文件夹下面。</li>
</ul>
</blockquote>
<h4 id="redies注解使用"><a href="#redies注解使用" class="headerlink" title="redies注解使用"></a>redies注解使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Spring提供了如下注解来声明缓存规则：</span><br><span class="line"></span><br><span class="line">@Cacheable triggers cache population</span><br><span class="line">@cacheevict triggers cache eviction</span><br><span class="line">@cacheput updates the cache without interfering with the method execution</span><br><span class="line">@caching regroups multiple cache operations to be applied on a method</span><br><span class="line">@cacheconfig shares some common cache-related settings at class-level</span><br><span class="line">注 解	描　述</span><br><span class="line">@Cacheable	表明Spring在调用方法之前，首先应该在缓存中查找方法的返回值。如果这个值能够找到，就会返回缓存的值。否则的话，这个方法就会被调用，返回值会放到缓存之中</span><br><span class="line">@cacheput	表明Spring应该将方法的返回值放到缓存中。在方法的调用前并不会 检查缓存，方法始终都会被调用</span><br><span class="line">@cacheevict	表明Spring应该在缓存中清除一个或多个条目</span><br><span class="line">@caching	这是一个分组的注解，能够同时应用多个其他的缓存注解</span><br><span class="line">@cacheconfig	可以在类层级配置一些共用的缓存配置</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="fkghost.com/2018/09/12/部署/redis/" data-id="cjqb5iyze000b0qksefx3bnf5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/deploy/">deploy</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/09/12/部署/yum的配置/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          yum
        
      </div>
    </a>
  
  
    <a href="/2018/09/11/部署/ngnix安装/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">nginx</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/">deploy</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/deploy/" style="font-size: 10px;">deploy</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/09/19/部署/mysql安装/">mysql</a>
          </li>
        
          <li>
            <a href="/2018/09/12/部署/yum的配置/">yum</a>
          </li>
        
          <li>
            <a href="/2018/09/12/部署/redis/">redis</a>
          </li>
        
          <li>
            <a href="/2018/09/11/部署/ngnix安装/">nginx</a>
          </li>
        
          <li>
            <a href="/2018/04/27/部署/Docker/">docker</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 xutong<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>